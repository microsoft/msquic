#
# This pipeline executes the interop runner for all implementations, or only the
# specified client and/or server.
#

trigger:
  batch: true
  branches:
    include:
    - main
  paths:
    exclude:
    - src/plugins/*
    - docs/*
    - README.md
pr: none

name: 0.$(Date:yyyy).$(Date:MM).$(DayOfMonth).$(Rev:rr).0

variables:
  ${{ if eq(variables['Build.Reason'], 'BatchedCI') }}:
    isMain: true
  ${{ if ne(variables['Build.Reason'], 'BatchedCI') }}:
    isMain: false

parameters:
- name: custom_build
  type: boolean
  displayName: Build docker image
  default: false
- name: measurements
  type: boolean
  displayName: Run Measurements
  default: false
- name: timeout
  type: number
  displayName: Timeout (min)
  default: 15
- name: client
  type: string
  displayName: Client
  default: 'all'
- name: server
  type: string
  displayName: Server
  default: 'all'

jobs:
- ${{ if or(parameters.custom_build, variables.isMain) }}:
  - job: publish_docker
    displayName: Build and Publish
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - checkout: self
      submodules: recursive
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: 'public/msquic/qns'
        dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
        containerRegistry: '9196310f-afae-4a53-8e35-b9e753eeb0f3'
        ${{ if variables.isMain }}:
          tags: |
            latest
            v1.1.0.$(Build.BuildId)
        ${{ if not(variables.isMain) }}:
          tags: custom-$(Build.BuildId)
- template: .\templates\run-qns.yml
  parameters:
    ${{ if or(parameters.custom_build, variables.isMain) }}:
      dependsOn: publish_docker
    timeout: ${{ parameters.timeout }}
    measurements: ${{ parameters.measurements }}
    ${{ if and(parameters.custom_build, not(variables.isMain)) }}:
      build: custom-$(Build.BuildId)
    ${{ if variables.isMain }}:
      clients: [ 'quic-go', 'quant', 'msquic' ]
      servers: [ 'quic-go', 'quant', 'msquic' ]
    ${{ if and(eq(parameters.client, 'all'), not(variables.isMain)) }}:
      clients: [ 'quic-go', 'quicly', 'ngtcp2', 'quant', 'mvfst', 'quiche', 'kwik', 'picoquic', 'aioquic', 'neqo', 'msquic' ]
    ${{ if and(ne(parameters.client, 'all'), not(variables.isMain)) }}:
      clients: [ '${{ parameters.client }}' ]
    ${{ if and(eq(parameters.server, 'all'), not(variables.isMain)) }}:
      servers: [ 'quic-go', 'quicly', 'ngtcp2', 'quant', 'mvfst', 'quiche', 'picoquic', 'aioquic', 'neqo', 'nginx', 'msquic' ]
    ${{ if and(ne(parameters.server, 'all'), not(variables.isMain)) }}:
      servers: [ '${{ parameters.server }}' ]
