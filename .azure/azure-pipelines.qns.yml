#
# This pipeline executes a single run of the interop runner between a chosen
# client and server implementation.
#
# TODO:
#  - Only pull running implementations.
#  - Specify an explicit log directory.
#  - Upload that log directory.
#  - Support running whole matrix in parallel.
#

trigger: none
pr: none

name: 0.$(Date:yyyy).$(Date:MM).$(DayOfMonth).$(Rev:rr).0

parameters:
- name: client
  type: string
  displayName: Client
  default: quant
- name: server
  type: string
  displayName: Server
  default: msquic
- name: clients
  type: string
  displayName: Clients
  values:
  - quicly
  - quic-go
  - quant
- name: servers
  type: string
  displayName: Servers
  values:
  - quicly
  - quic-go
  - quant
  - msquic

stages:
- ${{ each client in parameters.clients }}:
  - ${{ each server in parameters.servers }}:
    - stage:
      displayName: ${{ client }} -> ${{ server }}
      jobs:
      - job:
        displayName: ${{ client }} -> ${{ server }}
        variables:
          runCodesignValidationInjection: false
        steps:
        - script: |
            sudo apt-get install -y python3-setuptools
            git clone "https://github.com/marten-seemann/quic-interop-runner.git"
            cd quic-interop-runner
            pip3 install -r requirements.txt
            python3 pull.py
            ls
          displayName: Setup

        - script: |
            cd quic-interop-runner
            python3 run.py -s ${{ server }} -c ${{ client }}
          displayName: Run
          continueOnError: true

        - task: CopyFiles@2
          displayName: Move Logs
          inputs:
            sourceFolder: '**/quic-interop-runner/**'
            targetFolder: $(Build.ArtifactStagingDirectory)/${{ client }}_${{ server }}

        - task: PublishBuildArtifacts@1
          displayName: Upload Logs
          inputs:
            artifactName: distribution
            pathToPublish: $(Build.ArtifactStagingDirectory)
            parallel: true
