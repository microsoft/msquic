#
# Continuous Integration (CI)
# This pipeline builds and validates MsQuic for all configurations.
#

trigger:
- master
pr:
- master

name: 0.$(Date:yyMM).$(DayOfMonth)$(Rev:rr).0

#
# Builds
#

stages:

- stage: build_windows
  displayName: Build Windows
  dependsOn: []
  jobs:
  # Officially supported configurations.
  # ARM/ARM64 currently fail at linker stage.
  - template: ./templates/build-config-user.yml
    parameters:
      image: windows-latest
      platform: windows
      arch: x86
      tls: schannel
  - template: ./templates/build-config-user.yml
    parameters:
      image: windows-latest
      platform: windows
      arch: x64
      tls: schannel
  # Other configurations.
  - template: ./templates/build-config-user.yml
    parameters:
      image: windows-latest
      platform: windows
      arch: x64
      tls: stub
  - template: ./templates/build-config-user.yml
    parameters:
      image: windows-latest
      platform: windows
      arch: x64
      tls: mitls

- stage: build_winkernel
  displayName: Build Windows Drivers
  dependsOn: []
  jobs:
  - template: ./templates/build-config-winkernel.yml
    parameters:
      arch: x64
  - template: ./templates/build-config-winkernel.yml
    parameters:
      arch: x86
  - template: ./templates/build-config-winkernel.yml
    parameters:
      arch: arm
  - template: ./templates/build-config-winkernel.yml
    parameters:
      arch: arm64

- stage: build_linux
  displayName: Build Linux
  dependsOn: []
  jobs:
  # Officially supported configurations.
  - template: ./templates/build-config-user.yml
    parameters:
      image: ubuntu-latest
      platform: linux
      arch: x64
      tls: openssl
      extraBuildArgs: -DisableLogs
  # Other configurations.
  - template: ./templates/build-config-user.yml
    parameters:
      image: ubuntu-latest
      platform: linux
      arch: x64
      tls: stub
      extraBuildArgs: -DisableLogs

#
# Mirror
#

- stage: mirror
  displayName: Mirror
  dependsOn:
  - build_windows
  - build_winkernel
  - build_linux
  condition: and(succeeded(), in(variables['Build.Reason'], 'IndividualCI', 'BatchedCI'))
  jobs:
  - template: ./templates/sync-mirror.yml

#
# Build Verification Tests
#

- stage: test_bvt
  displayName: Build Verification Tests
  dependsOn:
  - build_windows
  - build_linux
  jobs:
  - template: ./templates/run-bvt.yml
    parameters:
      image: windows-latest
      platform: windows
      arch: x64
      tls: schannel
      extraArgs: -Filter "ParameterValidation.*:-*Events"
  - template: ./templates/run-bvt.yml
    parameters:
      image: windows-latest
      platform: windows
      arch: x64
      tls: mitls
      logProfile: Full.Light
      extraArgs: -Filter -*Unreachable/0:CryptTest/CryptTest.Encryption/2
# OpenSSL tests are broken because they can't load on a different
# machine from where they were built.
#  - template: ./templates/run-bvt.yml
#    parameters:
#      image: ubuntu-latest
#      platform: linux
#      arch: x64
#      tls: openssl
  - template: ./templates/run-bvt.yml
    parameters:
      image: ubuntu-latest
      platform: linux
      config: Release
      arch: x64
      tls: stub

#
# SpinQuic Tests
#

- stage: spinquic
  displayName: SpinQuic Tests
  dependsOn:
  - build_windows
  - build_linux
  jobs:
  - template: ./templates/run-spinquic.yml
    parameters:
      image: windows-latest
      platform: windows
      arch: x64
      tls: stub
  - template: ./templates/run-spinquic.yml
    parameters:
      image: ubuntu-latest
      platform: linux
      arch: x64
      tls: stub
