# This template contains steps to merge all builds into a single set of files to distribute.

jobs:
- job: distribution
  displayName: Distribution
  variables:
  - name: runCodesignValidationInjection
    value: false
  - name: skipComponentGovernanceDetection
    value: true
  pool:
    vmImage: windows-latest
  steps:
  - checkout: self
  - task: DownloadPipelineArtifact@2
    inputs:
      source: specific
      project: $(resources.pipeline.onebranch.projectID)
      pipeline: $(resources.pipeline.onebranch.pipelineID)
      preferTriggeringPipeline: true
      runVersion: specific
      runId: $(resources.pipeline.onebranch.runID)
      artifact: drop_build_build_windows_schannel_Release
      path: $(Build.SourcesDirectory)\artifacts\bin\windows
  - task: DownloadPipelineArtifact@2
    inputs:
      source: specific
      project: $(resources.pipeline.onebranch.projectID)
      pipeline: $(resources.pipeline.onebranch.pipelineID)
      preferTriggeringPipeline: true
      runVersion: specific
      runId: $(resources.pipeline.onebranch.runID)
      artifact: drop_build_build_windows_openssl_Release
      path: $(Build.SourcesDirectory)\artifacts\bin\windows

  - task: DownloadPipelineArtifact@2
    inputs:
      source: specific
      project: $(resources.pipeline.onebranch.projectID)
      pipeline: $(resources.pipeline.onebranch.pipelineID)
      preferTriggeringPipeline: true
      runVersion: specific
      runId: $(resources.pipeline.onebranch.runID)
      artifact: drop_build_build_windows_schannel_Debug
      path: $(Build.SourcesDirectory)\artifacts\bin\windows
  - task: DownloadPipelineArtifact@2
    inputs:
      source: specific
      project: $(resources.pipeline.onebranch.projectID)
      pipeline: $(resources.pipeline.onebranch.pipelineID)
      preferTriggeringPipeline: true
      runVersion: specific
      runId: $(resources.pipeline.onebranch.runID)
      artifact: drop_build_build_windows_openssl_Debug
      path: $(Build.SourcesDirectory)\artifacts\bin\windows

  - task: DownloadPipelineArtifact@2
    inputs:
      source: specific
      project: $(resources.pipeline.onebranch.projectID)
      pipeline: $(resources.pipeline.onebranch.pipelineID)
      preferTriggeringPipeline: true
      runVersion: specific
      runId: $(resources.pipeline.onebranch.runID)
      artifact: drop_build_build_UWP_schannel_Release
      path: $(Build.SourcesDirectory)\artifacts\bin\uwp
  - task: DownloadPipelineArtifact@2
    inputs:
      source: specific
      project: $(resources.pipeline.onebranch.projectID)
      pipeline: $(resources.pipeline.onebranch.pipelineID)
      preferTriggeringPipeline: true
      runVersion: specific
      runId: $(resources.pipeline.onebranch.runID)
      artifact: drop_build_build_UWP_openssl_Release
      path: $(Build.SourcesDirectory)\artifacts\bin\uwp

  - task: DownloadPipelineArtifact@2
    inputs:
      source: specific
      project: $(resources.pipeline.onebranch.projectID)
      pipeline: $(resources.pipeline.onebranch.pipelineID)
      preferTriggeringPipeline: true
      runVersion: specific
      runId: $(resources.pipeline.onebranch.runID)
      artifact: drop_build_build_UWP_schannel_Debug
      path: $(Build.SourcesDirectory)\artifacts\bin\uwp
  - task: DownloadPipelineArtifact@2
    inputs:
      source: specific
      project: $(resources.pipeline.onebranch.projectID)
      pipeline: $(resources.pipeline.onebranch.pipelineID)
      preferTriggeringPipeline: true
      runVersion: specific
      runId: $(resources.pipeline.onebranch.runID)
      artifact: drop_build_build_UWP_openssl_Debug
      path: $(Build.SourcesDirectory)\artifacts\bin\uwp

  - task: PowerShell@2
    displayName: Distribution
    inputs:
      pwsh: false
      filePath: scripts/package-distribution.ps1

  - task: CopyFiles@2
    displayName: Move Distribution
    inputs:
      sourceFolder: artifacts/dist
      targetFolder: $(Build.ArtifactStagingDirectory)

  - task: PublishBuildArtifacts@1
    displayName: Upload Distribution
    inputs:
      artifactName: distribution
      pathToPublish: $(Build.ArtifactStagingDirectory)
      parallel: true
