#
# Uploads SIGNED packages generated by Official build pipeline
#
trigger: none # https://aka.ms/obpipelines/triggers

resources:
  pipelines:
  - pipeline: onebranch   # Name of the pipeline resource
    source: msquic-Official # Name of the pipeline referenced by the pipeline resource
    trigger: true

name: 0.$(Date:yyyy).$(Date:MM).$(DayOfMonth).$(Rev:rr).0

variables:
  DisableDockerDetector: true

stages:
- stage: UploadPackage_stage
  jobs:
  - job: UploadPackage
    workspace:
      clean: all
    pool:
      vmImage: 'ubuntu-latest'
    strategy:
      matrix:
        openssl:
          openssl_name: openssl
          artifact_suffix: '_openssl'
          rpmrepos: 'opensslrpmrepos'
          debrepos: 'openssldebrepos'
        openssl3:
          openssl_name: openssl3
          artifact_suffix: '_openssl3'
          rpmrepos: ''
          debrepos: 'openssl3debrepos'
    variables:
    - group: MsQuicAADApp
    steps:
      - task: DownloadPipelineArtifact@2
        inputs:
          source: specific
          project: $(resources.pipeline.onebranch.projectID)
          pipeline: $(resources.pipeline.onebranch.pipelineID)
          preferTriggeringPipeline: true
          runVersion: specific
          runId: $(resources.pipeline.onebranch.runID)
          artifact: drop_package_linux_distribution_$(artifact_suffix)
          path: $(Build.SourcesDirectory)/artifacts/signed/$(openssl_name)
      - task: Docker@2
        displayName: Login to ACR
        inputs:
          command: login
          containerRegistry: msquicdockerregistry
      - template: ./obtemplates/upload-linux-packages.yml@self
        parameters:
          package_path: $(Build.SourcesDirectory)/artifacts/signed/$(openssl_name)
          rpmrepos: $(rpmrepos)
          debrepos: $(debrepos)
