#
# Uploads SIGNED packages generated by Official build pipeline
#
trigger: none # https://aka.ms/obpipelines/triggers

resources:
  pipelines:
  - pipeline: onebranch     # Name of the pipeline resource
    source: msquic-Official # Name of the pipeline referenced by the pipeline resource
    trigger: true

name: 0.$(Date:yyyy).$(Date:MM).$(DayOfMonth).$(Rev:rr).0

variables:
  DisableDockerDetector: true

parameters:
- name: opensslrpmrepos
  type: object
  default:
  - microsoft-sles12-prod-yum
  - microsoft-sles15-prod-yum
  - microsoft-centos7-prod-yum
  - microsoft-centos8-prod-yum
  - microsoft-opensuse15-prod-yum
  - microsoft-fedora32-prod-yum
  - microsoft-fedora33-prod-yum
  - microsoft-fedora34-prod-yum
  - microsoft-rhel7.3-prod-yum
  - microsoft-rhel8.0-prod-yum
  - microsoft-rhel8.1-prod-yum
  - cbl-mariner-1.0-prod-Microsoft-x86_64-rpms-yum
  - cbl-mariner-2.0-prod-Microsoft-x86_64-yum
  - cbl-mariner-2.0-prod-Microsoft-aarch64-yum
- name: openssldebrepos
  type: object
  default:
  - microsoft-ubuntu-xenial-prod-apt
  - microsoft-debian-stretch-prod-apt
  - microsoft-ubuntu-bionic-prod-apt
  - microsoft-debian-buster-prod-apt
  - microsoft-ubuntu-focal-prod-apt
  - microsoft-ubuntu-groovy-prod-apt
  - microsoft-ubuntu-hirsute-prod-apt
  - microsoft-debian-bullseye-prod-apt
- name: openssl3debrepos
  type: object
  default:
  - microsoft-ubuntu-jammy-prod-apt
  - microsoft-ubuntu-kinetic-prod-apt
  - microsoft-ubuntu-lunar-prod-apt
- name: openssl3rpmrepos
  type: object
  default:
  - microsoft-fedora36-prod-yum
  - microsoft-fedora37-prod-yum
  - microsoft-fedora38-prod-yum
  - microsoft-rhel9.0-prod-yum

stages:
- stage: UploadPackage_stage
  condition: startsWith(variables['Build.SourceBranch'], 'refs/tags/')
  jobs:
  - job: UploadPackage
    workspace:
      clean: all
    pool:
      vmImage: 'ubuntu-latest'
    variables:
    - group: MsQuicAADApp
    steps:
      - task: DownloadPipelineArtifact@2
        inputs:
          source: specific
          project: $(resources.pipeline.onebranch.projectID)
          pipeline: $(resources.pipeline.onebranch.pipelineID)
          preferTriggeringPipeline: true
          runVersion: specific
          runId: $(resources.pipeline.onebranch.runID)
          artifact: drop_package_linux_distribution_openssl
          path: $(Build.SourcesDirectory)/artifacts/signed/openssl
      - task: DownloadPipelineArtifact@2
        inputs:
          source: specific
          project: $(resources.pipeline.onebranch.projectID)
          pipeline: $(resources.pipeline.onebranch.pipelineID)
          preferTriggeringPipeline: true
          runVersion: specific
          runId: $(resources.pipeline.onebranch.runID)
          artifact: drop_package_linux_distribution_openssl3
          path: $(Build.SourcesDirectory)/artifacts/signed/openssl3
      - task: DownloadSecureFile@1
        name:  pmcv4cert
        displayName: 'Download cert for PMC v4'
        inputs:
          secureFile: 'auth.pem'
      - task: Docker@2
        displayName: Login to ACR
        inputs:
          command: login
          containerRegistry: msquicdockerregistry
      - ${{ each repo in parameters.opensslrpmrepos }}:
        - script: sh scripts/upload-linux-packages.sh -i $(PMCv4ClientId) -c $(pmcv4cert.secureFilePath) -f $(Build.SourcesDirectory)/artifacts/signed/openssl -r ${{ repo }} -n "*.rpm"
          displayName: Upload openssl RPM packages to ${{ repo }}
      - ${{ each repo in parameters.openssldebrepos }}:
        - script: sh scripts/upload-linux-packages.sh -i $(PMCv4ClientId) -c $(pmcv4cert.secureFilePath) -f $(Build.SourcesDirectory)/artifacts/signed/openssl -r ${{ repo }} -n "*.deb"
          displayName: Upload openssl DEB packages to ${{ repo }}
      - ${{ each repo in parameters.openssl3debrepos }}:
        - script: sh scripts/upload-linux-packages.sh -i $(PMCv4ClientId) -c $(pmcv4cert.secureFilePath) -f $(Build.SourcesDirectory)/artifacts/signed/openssl3 -r ${{ repo }} -n "*.deb"
          displayName: Upload openssl3 DEB packages to ${{ repo }}
      - ${{ each repo in parameters.openssl3rpmrepos }}:
        - script: sh scripts/upload-linux-packages.sh -i $(PMCv4ClientId) -c $(pmcv4cert.secureFilePath) -f $(Build.SourcesDirectory)/artifacts/signed/openssl3 -r ${{ repo }} -n "*.rpm"
          displayName: Upload openssl3 RPM packages to ${{ repo }}
