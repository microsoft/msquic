#
# Uploads SIGNED packages generated by Official build pipeline
#
trigger: none # https://aka.ms/obpipelines/triggers

resources:
  pipelines:
  - pipeline: onebranch     # Name of the pipeline resource
    source: msquic-Official # Name of the pipeline referenced by the pipeline resource
    trigger:
      tags:
      - v*

name: 0.$(Date:yyyy).$(Date:MM).$(DayOfMonth).$(Rev:rr).0

variables:
  DisableDockerDetector: true

parameters:
- name: opensslrpmrepos
  type: object
  default:
  - 582bd4c5ae062a5d0fec5b8b # microsoft-rhel7.3-prod
  - 584a0f48d6a6e37205720776 # microsoft-sles12-prod
  - 59d40cdcf3c7fa07032ce385 # microsoft-centos7-prod
  - 5c38ea9dea0fc9f93bd67db4 # microsoft-opensuse15-pro
  - 5c3d1796ea0fc9f93bd67def # microsoft-sles15-prod
  - 5e5ed94a523a8019fe47607e # microsoft-centos8-prod
  - 5e8526cde45fff4588da61f9 # microsoft-fedora32-prod
  - 5f7e2cfb68e42e6e7085f4df # microsoft-fedora33-prod
  - 6001dd94435efd1330acd076 # microsoft-rhel8.1-prod
  - 606e1da573e50659b0803a7b # microsoft-fedora34-prod
  - 6271bc683ac6d73aa84d6737 # microsoft-fedora36-prod
  - 6400e6f92dd6874e6880b590 # microsoft-fedora37-prod
- name: openssldebrepos
  type: object
  default:
  - 582bd623ae062a5d0fec5b8c # microsoft-ubuntu-xenial-prod
  - 599211761cc20bce4a8ab950 # microsoft-debian-stretch-prod
  - 5a9dc3f2424a5c053cc3ff2e # microsoft-ubuntu-bionic-prod
  - 5d23b16c9a6e3b375bbba42e # microsoft-debian-buster-prod
  - 5e852952e45fffa1beda61fe # microsoft-ubuntu-focal-prod
  - 5f7e2d6668e42e03f785f4e0 # microsoft-ubuntu-groovy-prod
  - 606e057173e5060519803a74 # microsoft-ubuntu-hirsute-prod
  - 611ab3a32acdcd0744c8c841 # microsoft-debian-bullseye-prod
- name: openssl3debrepos
  type: object
  default:
  - 61faea6cea3a770ab120ac8a # microsoft-ubuntu-jammy-prod

stages:
- stage: UploadPackage_stage
  jobs:
  - job: UploadPackage
    workspace:
      clean: all
    pool:
      vmImage: 'ubuntu-latest'
    variables:
    - group: MsQuicAADApp
    steps:
      - task: DownloadPipelineArtifact@2
        inputs:
          source: specific
          project: $(resources.pipeline.onebranch.projectID)
          pipeline: $(resources.pipeline.onebranch.pipelineID)
          preferTriggeringPipeline: true
          runVersion: specific
          runId: $(resources.pipeline.onebranch.runID)
          artifact: drop_package_linux_distribution_openssl
          path: $(Build.SourcesDirectory)/artifacts/signed/openssl
      - task: DownloadPipelineArtifact@2
        inputs:
          source: specific
          project: $(resources.pipeline.onebranch.projectID)
          pipeline: $(resources.pipeline.onebranch.pipelineID)
          preferTriggeringPipeline: true
          runVersion: specific
          runId: $(resources.pipeline.onebranch.runID)
          artifact: drop_package_linux_distribution_openssl3
          path: $(Build.SourcesDirectory)/artifacts/signed/openssl3
      - task: Docker@2
        displayName: Login to ACR
        inputs:
          command: login
          containerRegistry: msquicdockerregistry
      - ${{ each repo in parameters.opensslrpmrepos }}:
        - script: sh scripts/upload-linux-packages.sh -i $(ClientId) -s $(Secret) -f $(Build.SourcesDirectory)/artifacts/signed/openssl -r ${{ repo }} -n "*.rpm"
          displayName: Upload openssl RPM packages to ${{ repo }}
      - ${{ each repo in parameters.openssldebrepos }}:
        - script: sh scripts/upload-linux-packages.sh -i $(ClientId) -s $(Secret) -f $(Build.SourcesDirectory)/artifacts/signed/openssl -r ${{ repo }} -n "*.deb"
          displayName: Upload openssl DEB packages to ${{ repo }}
      - ${{ each repo in parameters.openssl3debrepos }}:
        - script: sh scripts/upload-linux-packages.sh -i $(ClientId) -s $(Secret) -f $(Build.SourcesDirectory)/artifacts/signed/openssl3 -r ${{ repo }} -n "*.deb"
          displayName: Upload openssl3 DEB packages to ${{ repo }}
