#
# Uploads a SIGNED package from a given URL to packages.microsoft.com.
#
trigger: none

parameters:
- name: TagName
  displayName: Tag Name (e.g. v2.2.0)
  type: string
  default: "v2.2.0"
jobs:
- job: UploadPackage
  workspace:
    clean: all
  pool:
    vmImage: 'ubuntu-latest'
  variables:
  - group: MsQuicAADApp
  steps:
    - task: Docker@2
      displayName: Login to ACR
      inputs:
        command: login
        containerRegistry: msquicdockerregistry
    - script: |
        echo "Tag = ${{ parameters.TagName }}"
        assets=($(curl https://api.github.com/repos/microsoft/msquic/releases/tags/${{ parameters.TagName }} | jq -r '.assets[] | select(.browser_download_url | contains("libmsquic")) | .browser_download_url'))
        mkdir output
        for asset in "${assets[@]}"
        do
          echo $asset
          filename=`basename $asset`
          wget -P ./output/ $asset
          OUTPUT=`realpath output`
          ls $OUTPUT
          docker run -v $OUTPUT:/usr/src/hostpwd msquicdockerregistry.azurecr.io/private/msquic/publish-linux-packages:latest -i $(ClientId) -s $(Secret) -f /usr/src/hostpwd/$filename
        done
