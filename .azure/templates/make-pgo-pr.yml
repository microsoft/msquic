jobs:
- job: make_pgo_pr
  displayName: Make PGO Pull Request
  pool:
    vmImage: ubuntu-latest
  variables:
  - name: runCodesignValidationInjection
    value: false
  - name: skipComponentGovernanceDetection
    value: true
  - group: DeploymentKeys
  steps:
  - checkout: none

  - task: PowerShell@2
    displayName: Prepare Test Machine
    inputs:
      targetType: inline
      pwsh: true
      script: |
        git clone --single-branch --branch main https://github.com/microsoft/msquic
        git config --global credential.helper store
        Set-Content -Path "$env:HOME\.git-credentials" -Value "https://$($env:MAPPED_DEPLOYMENT_KEY):x-oauth-basic@github.com`n" -NoNewLine

        # Set Git Config Info
        Set-Location msquic
        git config user.email "quicdev@microsoft.com"
        git config user.name "QUIC Dev[bot]"
    env:
      MAPPED_DEPLOYMENT_KEY: $(GitHubDeploymentKey)

  - task: DownloadBuildArtifacts@0
    displayName: Download Perf Artifacts
    inputs:
      artifactName: performance
      downloadPath: msquic/artifacts/PerfDataResults

  - task: PowerShell@2
    displayName: Copy Files
    inputs:
      targetType: inline
      pwsh: true
      script: Copy-Item -Path msquic/artifacts/PerfDataResults/performance/windows/x64_Release_schannel/msquic.pgd msquic/src/bin/winuser/pgo_x64/msquic.schannel.pgd -Force

  - task: PowerShell@2
    displayName: Create Branch, Commit, and Pull Request
    inputs:
      targetType: inline
      pwsh: true
      script: |
        Set-Location msquic
        $BranchName = "merge-pgo-$(get-date -format 'yyyy-MM-dd')"
        git checkout -b $BranchName
        git commit -am "Update PGO data"
        git push --set-upstream origin $BranchName

        $Headers = @{
          'Accept' = 'application/vnd.github+json'
          'Authorization' = "token $($env:MAPPED_DEPLOYMENT_KEY)"
        }
        $Uri = "https://api.github.com/repos/microsoft/msquic/pulls"
        $Body = @{
          'title' = '[Automated] Update PGO'
          'head' = "$($BranchName)"
          'base' = 'main'
          'body' = 'Update the PGO database with the latest perf numbers'
          'maintainer_can_modify' = $True
        }
        $Result = Invoke-RESTMethod -Uri $Uri -Headers $Headers -Body ($Body | ConvertTo-Json) -ContentType "application/json" -Method Post
        Write-Host $Result
        $Number = ($Result | Select-Object -Property 'number')

        $Uri = "https://api.github.com/repos/microsoft/msquic/issues/$($Number.number)/labels"
        $Body = @{
          'labels' = 'Area: Automation','Area: Performance'
        }
        $Result = Invoke-RESTMethod -Uri $Uri -Headers $Headers -Body ($Body | ConvertTo-Json) -ContentType "application/json" -Method Post

    env:
      MAPPED_DEPLOYMENT_KEY: $(GitHubDeploymentKey)
