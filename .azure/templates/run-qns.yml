#
# This pipeline executes a single run of the interop runner between a chosen
# client and server implementation.
#

parameters:
  build: ''
  dependsOn: []
  timeout: 25

jobs:
  - ${{ each client in parameters.clients }}:
    - ${{ each server in parameters.servers }}:
      - job:
        displayName: ${{ client }} -> ${{ server }}
        dependsOn: ${{ parameters.dependsOn }}
        variables:
          runCodesignValidationInjection: false
        steps:
        - checkout: none
        - script: |
            sudo apt-get install -y cmake libglib2.0-dev libgcrypt20-dev flex \
              bison byacc libpcap-dev ninja-build
            sudo apt-get install -y libglib2.0-dev qttools5-dev qttools5-dev-tools \
              libqt5svg5-dev qtmultimedia5-dev qt5-default libc-ares-dev \
              libpcap-dev bison flex make python3 perl libgcrypt-dev \
              libnl-3-dev libkrb5-dev libsmi2-dev asciidoctor libsbc-dev liblua5.2-dev \
              libnl-cli-3-dev libparse-yapp-perl libcap-dev liblz4-dev libsnappy-dev \
              libzstd-dev libspandsp-dev libxml2-dev libminizip-dev ninja-build \
              xsltpro libspeexdsp-dev
            wget https://gitlab.com/wireshark/wireshark/-/jobs/artifacts/master/download?job=build%3Adebian-stable
            unzip ./download?job=build%3Adebian-stable
            sudo dpkg -i --force-depends ./debian-packages/*
          displayName: Install Wireshark

        - script: |
            sudo apt-get install -y python3-setuptools
            git clone "https://github.com/marten-seemann/quic-interop-runner.git"
            cd quic-interop-runner
            pip3 install -r requirements.txt
            python3 pull.py -i ${{ client }},${{ server }}
          displayName: Setup Runner

        - ${{ if ne(parameters.build, '') }}:
          - script: |
              cd quic-interop-runner
              python3 run.py -l ./logs -s ${{ server }} -c ${{ client }} --replace msquic=mcr.microsoft.com/msquic/qns:${{ parameters.build }} || true
            displayName: Run Tests
            timeoutInMinutes: ${{ parameters.timeout }}
            continueOnError: true

        - ${{ if eq(parameters.build, '') }}:
          - script: |
              cd quic-interop-runner
              python3 run.py -l ./logs -s ${{ server }} -c ${{ client }} || true
            displayName: Run Tests
            timeoutInMinutes: ${{ parameters.timeout }}
            continueOnError: true

        - task: PublishPipelineArtifact@1
          displayName: Upload Logs
          inputs:
            targetPath: quic-interop-runner/logs/${{ server }}_${{ client }}
            artifactName: qns_${{ server }}_${{ client }}
