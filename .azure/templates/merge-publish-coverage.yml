# This template contains steps to run the BVTs for a single configuration.

parameters:
  platform: ''
  config: ''
  arch: ''
  tls: ''

jobs:
- job: merge_cc_${{ parameters.platform }}_${{ parameters.arch }}_${{ parameters.tls }}
  displayName: ${{ parameters.platform }} ${{ parameters.arch }} ${{ parameters.tls }}
  dependsOn:
  - bvt_windows_x64_schannel_false_true
  - spin_windows_x64_schannel
  condition: or(succeeded(), failed())
  steps:
  - task: PowerShell@2
    displayName: Prepare Test Machine
    inputs:
      pwsh: true
      filePath: scripts/prepare-machine.ps1
      arguments: -Configuration Test

  - task: DownloadBuildArtifacts@0
    displayName: Download Build Artifacts
    inputs:
      artifactName: coverage
      itemPattern: logs/${{ parameters.platform }}/${{ parameters.arch }}_${{ parameters.config }}_${{ parameters.tls }}/**/*.cov
      downloadPath: artifacts/coverage

  - task: Powershell@2
    displayName: Merge coverage
    inputs:
      pwsh: true
      filePath: scripts/merge-coverage.ps1

  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: 'cobertura'
      summaryFileLocation: '**/artifacts/coverage/msquiccoverage.xml'
