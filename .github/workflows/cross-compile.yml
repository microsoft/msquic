name: Cross Compile MsQuic

on:
  push:
    branches:
    - main
    paths:
    - .github/workflows/cross-compile.yml
    - src/core/*
    - src/platform/*
    - src/bin/*
    - src/inc/*
    - src/perf/*
    - src/tools/*
    - src/test/*
    - submodules/openssl/*
  pull_request:
    branches:
    - main
    paths:
    - .github/workflows/cross-compile.yml
    - src/core/*
    - src/platform/*
    - src/bin/*
    - src/inc/*
    - src/perf/*
    - src/tools/*
    - src/test/*
    - submodules/openssl/*

concurrency:
  # Cancel any workflow currently in progress for the same PR.
  # Allow running concurrently with any other commits.
  group: containers-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

permissions: read-all

jobs:
  build-arm:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/microsoft/msquic/linux-build-xcomp
    name: Build Arm/Arm64
    steps:
    - name: Checkout repository
      uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b
      with:
        fetch-depth: 2
        submodules: 'recursive'
    - name: Prepare Machine
      shell: pwsh
      run: scripts/prepare-machine.ps1 -ForOneBranch -InitSubmodules
    - name: Build Debug Arm
      shell: pwsh
      run: scripts/build.ps1 -Config Debug -DisableLogs -Arch arm -ToolchainFile cmake/toolchains/arm-linux.cmake -OneBranch
    - name: Build Release Arm
      shell: pwsh
      run: scripts/build.ps1 -Config Release -DisableLogs -Arch arm -ToolchainFile cmake/toolchains/arm-linux.cmake -OneBranch
    - name: Build Debug Arm64
      shell: pwsh
      run: scripts/build.ps1 -Config Debug -DisableLogs -Arch arm64 -ToolchainFile cmake/toolchains/aarch64-linux.cmake -OneBranch
    - name: Build Release Arm64
      shell: pwsh
      run: scripts/build.ps1 -Config Release -DisableLogs -Arch arm64 -ToolchainFile cmake/toolchains/aarch64-linux.cmake -OneBranch
